name: WT XS v0.7.0.beta9-SA
pvp: true

slots:
    core:
        class: CoreUnit
    shield:
        class: ShieldGeneratorUnit
    weapon:
        class: WeaponUnit
        select: manual
    warpdrive:
        class: WarpDriveUnit
    spacefueltank:
        class: SpaceFuelContainer
        select: manual
    atmofueltank:
        class: AtmoFuelContainer
        select: manual
    rocketfueltank:
        class: RocketFuelContainer
        select: manual
    radar:
        class: RadarPVPUnit
        select: manual
    db:
        class: DatabankUnit
        select: manual
    ammoCont:
        class: AmmoContainerUnit
        select: manual

handlers:
    unit:
        onStart:
            lua: |
                showARCompass = true --export
                holdBrakeOnInit = true --export
                autoRes = true --export
                autoResMode = 1 --export
                autoResMinHitCount = 0 --export
                shieldDebugLog = false --export
                maxAngularSpeed = 0 --export
                burnLimiter = true --export
                burnLimiterSpeed = 0 --export
                defaultHoverAltitude = 4 --export
                showGuiOutline = true --export
                airfoilTorque = false --export
                showAtmoRelatedButtons = true --export
                showShieldRelatedButtons = true --export
                targetLandingSpeed = -1 --export
                
                Nav = Navigator.new(self.system, self.core, self.unit)
                pitchInput = 0
                rollInput = 0
                yawInput = 0
                dampingOff = 0
                autoLevel = 0
                altitudeHold = nil
                groundStabilization = true
                screenHeight = system.getScreenHeight()
                screenWidth = system.getScreenWidth()
                brakeInput = 0
                brakeLock = false
                landingMode = false
                manualVerticalInput = false

                if holdBrakeOnInit and vec3(construct.getWorldVelocity()):len()<100 then
                    brakeInput = 1
                    brakeLock = true
                    groundStabilization = false
                    local curAlt = core.getAltitude()
                    if curAlt ~= nil and curAlt ~= 0 then
                        landingMode = true
                        unit.deployLandingGears()
                    end
                else
                    unit.retractLandingGears()
                end

                function shieldClass(a,b,c,d,e,f,g)if d==nil then d=true end;if g==nil then g=false end;local h={}local i={MAX=0,MAX2=1,RATIO=2}e=e or i.MAX2;f=f or 0;local j=nil;local k={0,0,0,0}local l=c.getResistances()local m={0,0,0,0}local n=1;local o=30;local p={}for q=1,o do p[#p+1]={0,0,0,0}end;local r={0,0,0,0}local s=0;local t=0;local u=0.0001;local v={}for q=1,120 do v[q]=c.getShieldHitpoints()/c.getMaxShieldHitpoints()end;local w={"AM","EM","KI","TH"}local function x(y,z)z=z or 1;local A=0;for q=1,#y do A=A+y[q]end;if A==0 then return{0,0,0,0}end;local B={}for q=1,#y do B[q]=y[q]/A*z end;return B end;local function C(D)local E={0,0,0,0}for F,G in ipairs(D)do for q,H in ipairs(G)do E[q]=E[q]+H end end;return E end;local function I(J)local K={}local L=#J;for q=1,L do K[q]=q end;local M=false;repeat M=false;for q=2,L do if J[K[q-1]]<J[K[q]]then K[q-1],K[q]=K[q],K[q-1]M=true end end until not M;return table.unpack(K)end;local function N(G,O)local P,Q,R,S=I(G)if G[P]>O*3 then G[P]=G[P]-O*3 end;G[Q]=G[Q]G[R]=G[R]+O*1;G[S]=G[S]+O*2 end;local function T(U)local V={}for q=1,#U do local W=U[q]if not V[W]then V[W]=true else return true end end;return false end;local function X(U,Y)for q=1,#U do if math.abs(U[q]-Y[q])>u/10 then return false end end;return true end;local function Z(_)local a0={0,0,0,0}local a1=I(_)a0[a1]=1;return a0 end;local function a2(_)local a0={0,0,0,0}local a3,a4=I(_)a0[a3]=1;if _[a4]>1 and _[a4]/_[a3]>0.3 then a0[a4]=1 end;return a0 end;local function a5(a6)local a7=x(a6,c.getResistancesPool())N(a7,u)if X(a7,l)or c.getResistancesCooldown()>0 then return end;local a8=c.setResistances(table.unpack(a7))if not a8 then a.print('wtShield ERROR (code: 4) ('..table.concat(a7,",")..')')else l=a7;a.print('Successfuly applied resistances ('..table.concat(a7,",")..')')end end;local function a9()if c.getResistancesCooldown()~=0 or X(r,{0,0,0,0})then return end;local a0;if e==i.MAX then a0=Z(r)elseif e==i.MAX2 then a0=a2(r)elseif e==i.RATIO then a0=k else a0={0.25,0.25,0.25,0.25}a.print('wtShield ERROR (code: 3)')end;a5(a0)end;function h.onDown()c.startVenting()end;function h.onVentingEvent(aa,ab)if not aa then c.activate()end end;function h.toogleAutoRes()d=not d;if d then j=nil end;a.print('AutoRes '..(d and'ON'or'OFF'))end;function h.manualOverride(a7)d=false;j=a7;a.print('AutoRes OFF, setting manual res to '..table.concat(a7,", "))end;function h.onAbsorb(ac,ad)local ae=0.9-ac/ad;local af;for q=1,#l do if math.abs(ae-l[q])<u/10 then if not af then af=q else a.print('wtShield ERROR (code: 1)')return end end end;if not af then a.print('wtShield ERROR (code: 2)')return end;if g then a.print('HIT '..w[af]..' '..ad)end;local ag=a.getUtcTime()t=t+1;m[af]=ag;p[#p][af]=p[#p][af]+ad;r=C(p)k=x(r)end;function h.onTick()local ag=a.getUtcTime()if d and t>0 and(f==0 or t>=f)and ag-math.max(table.unpack(m))<o*n*0.8 then a9()end;if j then a5(j)end;s=t;table.remove(p,1)p[#p+1]={0,0,0,0}r=C(p)k=x(r)if X(r,{0,0,0,0})then t=0 end;table.remove(v,1)v[120]=c.getShieldHitpoints()/c.getMaxShieldHitpoints()end;function h.getStressRatio()return k end;function h.getLastHitTimes()return m end;function h.getShieldHistory()return v end;function h.getAutoRes()return d end;function h.getAutoResModeStr()if not d then return'OFF'elseif e==0 then return'MAX'elseif e==1 then return'MAX2'elseif e==2 then return'RATIO'end end;a.print('currentRes: '..table.concat(l,", "))if d then a5({1,1,1,1})elseif T(l)then a.print('found equal resists, unequalizing...')a5(l)end;b.setTimer('wtShieldTick',n)return h end

                function audioManagerClass(a)local b={}local c={}function b.onUpdate()if a.isPlayingSound()then return end;if c[1]==nil then return end;a.playSound(c[1])table.remove(c,1)end;function b.playSound(d)table.insert(c,d)end;return b end;function monitorClass(a,e,f,g)local h={}local i;local j=audioManagerClass(a)local k=0.3;local l=0.1;local m=0.4;local n=0.1;local o=0.4;local p=0.1;local q="wthud/fuelLow.mp3"local r="wthud/fuelCritical.mp3"local s="wthud/shieldLow.mp3"local t="wthud/shieldCritical.mp3"local u="wthud/ccsLow.mp3"local v="wthud/ccsCritical.mp3"local w="wthud/targetAccelerating.mp3"local x="wthud/targetBraking.mp3"local function y()local z={}if sheild~=nil then z.shieldHpRatio=f.getShieldHitpoints()/f.getMaxShieldHitpoints()end;z.stressHpRatio=e.getMaxCoreStress()>0 and e.getCoreStress()/e.getMaxCoreStress()or 0;z.fuelPercent=g~=nil and g.getItemsVolume()/g.getMaxVolume()or 0;return z end;function h.onUpdate()local z=y()if f~=nil then if(i.shieldHpRatio or 0)>m and z.shieldHpRatio<=m then j.playSound(s)end;if(i.shieldHpRatio or 0)>n and z.shieldHpRatio<=n then j.playSound(t)end end;if i.stressHpRatio>o and z.stressHpRatio<=o then j.playSound(u)end;if i.stressHpRatio>p and z.stressHpRatio<=p then j.playSound(v)end;if i.fuelPercent>k and z.fuelPercent<=k then j.playSound(q)end;if i.fuelPercent>l and z.fuelPercent<=l then j.playSound(r)end;i=z;j.onUpdate()end;i=y()return h end

                if shield ~= nil then
                    wtShield = shieldClass(system, unit, shield, autoRes, autoResMode, autoResMinHitCount, shieldDebugLog)
                end
                wtMonitor = monitorClass(system, core, shield, spacefueltank_1)
                
                unit.hideWidget()
                if warpdrive ~= nil then warpdrive.showWidget() end
                system.showHelper(0)
                system.showScreen(1)
                
                function PilotHUDClass(a,b,c,d,e,f,g,h,i,j,l,m)local n={}local o="black"local p="#b6dbe7"local q="1"local r=[[
                <style>
                .ui {
                    color: ]]..p..[[;
                    font: Inconsolata, monospace;
                    font-family: monospace;
                    font-size: 0.75em;
                    font-weight: bold;
                    opacity: ]]..q..[[;
                    white-space: pre;
                    text-shadow: -1px -1px 0 ]]..o..[[, 1px -1px 0 ]]..o..[[, -1px 1px 0 ]]..o..[[, 1px 1px 0 ]]..o..[[;
                }
                .blue {
                    color: #5BD8FF;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                .red {
                    color: #FF5B72;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                .orange {
                    color: #fc934f;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                .yellow {
                    color: #fce94f;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                .green {
                    color: #72ff5b;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                </style>]]local s=0;local t=0;local u=nil;local v=nil;local w=require('atlas')local function x(y)local z=" *([+-]?%d+%.?%d*e?[+-]?%d*)"local A="::pos{"..z..","..z..","..z..","..z..","..z.."}"local B,C,D,E,F=string.match(y,A)if B==nil or C==nil or D==nil or E==nil or F==nil then a.print("Error converting POS")return vec3()end;if B=="0"and C=="0"then return vec3(D,E,F)end;E=math.rad(E)D=math.rad(D)local G=w[tonumber(B)][tonumber(C)]local H=math.cos(D)local I=vec3(H*math.cos(E),H*math.sin(E),math.sin(D))return vec3(G.center)+(G.radius+F)*I end;local function J(K)K=vec3(K)return"::pos{0,0,"..K.x..","..K.y..","..K.z.."}"end;local L={}local function M()if db_1~=nil and db_1.hasKey('AR')then local N=0;for k,O in pairs(json.decode(db_1.getStringValue('AR')))do L[k]=O;N=N+1 end;a.print('Loaded '..N..' AR marks from databank')end end;local function P()if db_1~=nil then db_1.setStringValue('AR',json.encode(L))a.print('saved AR marks to databank')end end;local function Q(K,R,S)L[R]={x(K),S}P()end;M()local T={}for U,V in pairs(w[0])do table.insert(T,V)end;local function W(X)X=X or 0;if X<1000 then return math.ceil(X)..'m'elseif X<1000*10 then return string.format("%.2fkm",X/1000)elseif X<1000*100 then return string.format("%.1fkm",X/1000)elseif X<1000*200*10 then return string.format("%.2fsu",X/1000/200)elseif X<1000*200*100 then return string.format("%.1fsu",X/1000/200)else return math.ceil(X/1000/200)..'su'end end;local function Y(K)local function Z(_,a0,a1)local a2=(a0-_):normalize()local a3=(a1-_):dot(a2)/a2:dot(a2)if a3<=0 then return a1:dist(_),_ elseif a3>=(a0-_):len()then return a1:dist(a0),a0 end;local a4=_+a3*a2;local a5=a4:dist(a1)return a5,a4 end;local a6=vec3({13771471,7435803,-128971})local a7=18000000;local a8=500000;local a9=math.huge;local aa=math.huge;local ab=math.huge;local ac=math.huge;local ad,ae,af,ag,ah;local ai=a6+(K-a6):normalize()*a7;local ac=K:dist(ai)local aj=K:dist(a6)>a7;for ak=1,#T do body1=T[ak]if body1.type[1]~="Asteroid"then local X=K:dist(vec3(body1.center))if X<a9 then a9=X;ad=body1 end;if body1.type[1]=="Planet"or body1.isSanctuary==true then if X<aa then aa=X;ae=body1 end;for al=ak+1,#T do body2=T[al]if body2.type[1]=="Planet"or body2.isSanctuary==true then local am,an=Z(vec3(body1.center),vec3(body2.center),K)if am<ab then ab=am;af=body1;ag=body2;ah=an end end end end end end;if aj then local ao=vec3(ad.center)+(K-vec3(ad.center)):normalize()*a8;local ap=(K-ao):len()if ap<ac then ac=ap;aj=(K-vec3(ad.center)):len()>a8;ai=ao end end;return{closestBody={body=ad,dist=a9},closestPipe={body1=af,body2=ag,dist=ab,point=ah},isPvP=aj,PvpBorderDist=ac,PvpBorderPos=ai}end;u=Y(vec3(d.getWorldPosition()))local aq=0;function n.onText(ar)ar=string.lower(ar)if ar:match('^addar%s(::pos.+})%s(.+)')~=nil then local K,R,S=ar:match('^addar%s(::pos.+})%s(.+)%s?(#%x?%x?%x?%x?%x?%x?)')if K==nil then K,R=ar:match('^addar%s(::pos.+})%s(.+)')S='#76f9e0'end;Q(K,R,S)elseif ar:match('^clearar')~=nil then local R=ar:match('^clearar%s(.+)')if R==nil then L={}else L[R]=nil end;P()elseif ar:match('^info')~=nil then local K=ar:match('^info%s(::pos.+})')local as=Y(x(K))a.print('Info on '..K)a.print('isPvP: '..(as.isPvP and'true'or'false'))a.print('Border ('..W(as.PvpBorderDist)..'): '..J(as.PvpBorderPos))a.print('closest Pipe ('..W(as.closestPipe.dist)..'): '..as.closestPipe.body1.name[1]..' - '..as.closestPipe.body2.name[1])a.print('closest Body ('..W(as.closestBody.dist)..'): '..as.closestBody.body.name[1])elseif ar:match('^helper$')~=nil then aq=1-aq;a.showHelper(aq)end end;local function at(au,av,G)local K=vec3(au)local O=vec3(av)local aw=vec3(G.center)local a3=K-aw;local ax=O:len2()local ay=a3:len()local az=G.GM;local aA=((ax-az/ay)*a3-a3:dot(O)*O)/az;local aB=az/(2*az/ay-ax)local aC=aA:len()local aD=aA:normalize()local aE=aB*(1-aC)local aF=aB*(1+aC)local aG=G.radius;local aH=aE*aD+aw;local aI=aE-aG;local aJ=nil;local aK=aF-aG;if aC<1 then aJ=-aF*aD+aw end;local aL=nil;if aJ~=nil then aL=2*math.pi*math.sqrt(aB^3/az)end;local aM=math.acos(aA:dot(a3)/(aC*ay))if a3:dot(O)<0 then aM=-(aM-2*math.pi)end;local aN=math.acos((math.cos(aM)+aC)/(1+aC*math.cos(aM)))local aO=aN;if aO<0 then aO=aO+2*math.pi end;local aP=aO-aC*math.sin(aO)local aQ=0;local aR=0;local aS=0;if aL~=nil then aQ=aP/(2*math.pi/aL)aR=aL-aQ;aS=aR+aL/2;if aM-math.pi>0 then aR=aQ;aS=aR+aL/2 end;if aS>aL then aS=aS-aL end else aR=(K-aH):len()/vec3(d.getVelocity()):len()end;return{aH,aI,aJ,aK,aR,aS}end;curOrbit=at(constructPos,constructVelocity,u.closestBody.body)local aT=a.getScreenHeight()local aU=a.getScreenWidth()local function aV(aw,aW)local aX={}local aY=vec3(0,0,1)local aZ=vec3(0,1,0)local aD=vec3(0,0,1)aX["00"]=aw+aD*aW;aX["50"]=aw-aD*aW;for ak=1,4 do aD=aD:rotate(math.pi/180*36,aZ)for al=0,9 do aD=aD:rotate(math.pi/180*36,aY)aX[''..ak..al]=aw+aD*aW end end;return aX end;local function a_(b0)return math.floor(b0+0.5)end;local function b1(b2,b3,S,b4,b5)local b6=400;local b7=c.getPointOnScreen({b3.x,b3.y,b3.z})if b7[3]<=0 then return''end;local b0=b7[1]*aU-b6/2;local b8=b7[2]*aT-b6/2;svg=[[<svg viewBox="0 0 500 500" class="point" style="left:]]..b0 ..[[px;top:]]..b8 ..[[px;position:absolute;width:]]..b6 ..[[px;height:]]..b6 ..[[px">]]if b2=='circle'then svg=svg..[[<circle cx="250" cy="250" r="10" opacity="0.75" stroke="]]..S..[[" stroke-width="2" fill="none"/>]]elseif b2=='cross'then svg=svg..[[<line x1="250" y1="242" x2="250" y2="258" opacity="0.75"  stroke="]]..S..[[" stroke-width="2"/><line x1="242" y1="250" x2="258" y2="250" opacity="0.5"  stroke="]]..S..[[" stroke-width="2"/>]]elseif b2=='triangle'then svg=svg..[[<line x1="242" y1="242" x2="250" y2="258" opacity="0.75"  stroke="]]..S..[[" stroke-width="2"/><line x1="258" y1="242" x2="250" y2="258" opacity="0.75"  stroke="]]..S..[[" stroke-width="2"/><line x1="242" y1="242" x2="258" y2="242" opacity="0.75"  stroke="]]..S..[[" stroke-width="2"/>]]elseif b2=='box'then svg=svg..[[<rect x="237" y="237" width="26" height="26" style="fill: rgba(0,0,0,0); stroke: ]]..S..[[; stroke-width: 2"/>]]end;svg=svg..[[<text x="50%" y ="47%" style="text-anchor: middle; stroke:#000; fill: ]]..S..[[; font-family: Arial, sans-serif; font-size: 14px;">]]..(b4 or'')..[[</text><text x="50%" y ="55%" style="text-anchor: middle; stroke:#000; fill: ]]..S..[[; font-family: Arial, sans-serif; font-size: 14px;">]]..(b5 or'')..[[</text></svg>]]return svg end;local function b9(b3,S,b4,b5)return b1('circle',b3,S,b4,b5)end;local function ba(b3,S)return b1('cross',b3,S)end;local function bb(d)local constructPos=vec3(d.getWorldPosition())local aX=aV(constructPos,10^7)local bc=''for R,b3 in pairs(aX)do bc=bc..b9(b3,"#cc8899",R)end;return bc end;local function bd(d)local constructPos=vec3(d.getWorldPosition())local w=require('atlas')local bc=''for U,V in pairs(w[0])do if V.type[1]~="Asteroid"then local X=(vec3(V.center)-constructPos):len()if not((V.type[1]~="Planet"or V.id==6)and X/10^3/200>20)then local be=math.floor(X/10^3/200).."su"bc=bc..b9(vec3(V.center),"#b6dbe7",V.name[1],be)end end end;local bf=vec3({13856549.3576,7386341.6738,-258459.8925})local be=math.floor((bf-constructPos):len()/10^3/200).."su"bc=bc..b9(bf,"#b6dbe7","Aegis",be)return bc end;local function bg(as)local S=as.isPvP and"#72ff5b"or"#FF5B72"local bh=as.isPvP and"Safe Zone"or"PVP"return b9(as.PvpBorderPos,S,bh,W(as.PvpBorderDist))end;local function bi(d,X)local bj=vec3(d.getWorldForward()):normalize()local K=vec3(d.getWorldPosition())local bk=K+bj*X;local bl=K-bj*X;local bm='#b6dbe7'local bn='#a11'local bc=ba(bk,bm)..ba(bl,bn)local bo=vec3(d.getWorldVelocity())if bo:len()>1 then local bp=bo:normalize()local bq=K+bp*X;local br=K-bp*X;bc=bc..b9(bq,bm)..b9(br,bn)end;return bc end;local function bs()local bc=''for R,bt in pairs(L)do local K,S=vec3(bt[1]),bt[2]local X=(K-vec3(d.getWorldPosition())):len()bc=bc..b1('box',K,S,R,W(X))end;return bc end;local function bu(as)local bc=''bc=bc..bd(d)bc=bc..bg(as)bc=bc..b9(as.closestPipe.point,'#b6dbe7','PIPE',W(as.closestPipe.dist))bc=bc..bs(d)return bc end;local function bv(bw,bx,by,bz)local bA='-'bz=bz or'█'local bB=math.floor(math.min(math.abs(math.max(bx-1,0)),1)*bw+0.5)local bC=math.floor(math.min(math.abs(bx),1)*bw+0.5)local bD;if bx>=0 then bD='[</a><a class="'..(by or'')..'">'..string.rep(bz,bC-bB)..'</a><a class="red">'..string.rep(bz,bB)..'</a><a>'..string.rep(bA,bw-bC)..']'elseif bx<0 then bD='['..string.rep(bA,bw-bC)..'</a><a class="red">'..string.rep(bz,bC).."</a><a>]"else bD='[</a><a class="red">'..string.rep('X',bw).."</a><a>]"end;return bD end;local function bE()local bF=d.getMass()local bG=0;local bH=d.getPlayersOnBoard()local bI=d.getPlayersOnBoardInVRStation()local bJ=d.getDockedConstructs()for U,bK in ipairs(bH)do bG=bG+d.getBoardedPlayerMass(bK)end;for U,bK in ipairs(bI)do bG=bG+d.getBoardedInVRStationAvatarMass(bK)end;for U,bK in ipairs(bJ)do bF=bF+d.getDockedConstructMass(bK)end;bF=bF+math.max(0,bG-20000)return bF end;local function bL(bM)local bN=bM;while true do bN,k=string.gsub(bN,"^(-?%d+)(%d%d%d)",'%1,%2')if k==0 then break end end;return bN end;local function bO(bP)bP=bP*3.6;return bL(math.floor(bP))..' km/h'end;local function bQ(bR)return string.format("%02d",math.floor(bR//60))..':'..string.format("%02d",math.floor(bR%60))end;local function bS(bR)if bR==-1 then return'ERR'elseif bR<60 then return math.floor(bR)..'s'elseif bR<60*60 then return math.floor(bR/60)..'m'elseif bR<60*60*24 then return math.floor(bR/(60*60))..'h'else return'1d+'end end;local function bT(bU)if bU<1000 then return math.floor(bU)elseif bU<1000*10 then return string.format("%.2fk",bU/1000)elseif bU<1000*100 then return string.format("%.1fk",bU/1000)elseif bU<1000*1000*10 then return string.format("%.2fm",bU/1000000)elseif bU<1000*200*100 then return string.format("%.1fm",bU/1000000)else return math.ceil(bU/1000000)..'m'end end;local function bV(bW)if bW<10 then return string.format("%.2fkg",bW)elseif bW<10^3 then return string.format("%.1fkg",bW)elseif bW<10^4 then return string.format("%.2ft",bW/10^3)elseif bW<10^5 then return string.format("%.1ft",bW/10^3)elseif bW<10^6 then return string.format("%.0ft",bW/10^3)elseif bW<10^7 then return string.format("%.2fkt",bW/10^6)elseif bW<10^8 then return string.format("%.1fkt",bW/10^6)else return string.format("%.0fkt",bW/10^6)end end;local function bX(bY,bZ)local bx={}for ak=1,#bY do bx[ak]=bY[ak]/bZ end;return bx end;local function b_()if curOrbit[2]>0 and curOrbit[2]<1000*50 then return b1('triangle',curOrbit[1],"#b6dbe7",W(curOrbit[2]),bQ(curOrbit[5]))else return''end end;local function c0()return[[
                <style>
                .main-outline {
                   position: absolute;
                   top: 67vh;
                   left: 28vw;
                   font-size: 0.9em;
                }
                </style>
                <div class="ui main-outline"><a>
                                                   _______________WT_HUD_v0.7.0.beta1__________
                                                  /                                            \
                      ___________________________/                                              \___________________________
                     /                          /                                                \                          \
                    /                          /                                                  \                          \
                   /                          /____________________________________________________\                          \
                  /                          |                                                      |                          \
                 /                           |                                                      |                           \
                /____________________________|                                                      |                            \
                |                            |                                                      |                            |
                |                            |                                                      |                            |
                |                            |                                                      |                            |
                |                            |                                                      |                            |
                |                            |                                                      |                            |
                |____________________________|______________________________________________________|____________________________|
                </a></div>
                ]]end;local function c1()local c2=string.format("%.1fg",vec3(d.getWorldAcceleration()):len()/9.80665)local c3=vec3(b.getEngineThrust('longitudinal')):len()local c4;local c5;local bY=d.getMaxThrustAlongAxis('longitudinal',d.getForward())if b.getAtmosphereDensity()>0.1 then c4=d.getFrictionBurnSpeed()c5=bY[1]elseif b.getAtmosphereDensity()>0 then c4=d.getFrictionBurnSpeed()c5=bY[1]+bY[3]else c4=d.getMaxSpeed()c5=bY[3]end;local c6=c5>0 and c3/c5 or 0;local c7=a_(c6*100)local c8=vec3(d.getWorldVelocity()):len()local c9=c8/c4;local ca=-1;if db_1~=nil and db_1.hasKey('targetSpeed')then ca=db_1.getIntValue('targetSpeed')end;local cb=(ca or 0)/c4;local cc;if ca~=-1 then local cd=bv(20,cb)local ce=string.format("%-14s",bO(ca))cc='target  '..cd..' '..ce else cc=string.rep(' ',48)end;local cf=bv(20,c9)..' '..string.format("%-14s",bO(c8))local cg;if b.getControlMode()==0 then local ch=b.getThrottle()/100;local ci=a_(ch*100)cg='throttle '..bv(20,ch)..' '..ci..'%'else local cj=b.getThrottle()/100/3.6;local ck=cj/c4;cg='  cruise '..bv(20,ck)..' '..bO(cj)end;return[[
                <style>
                .text-1 {
                   position: absolute;
                   top: 69.3vh;
                   left: 43vw;
                   font-size: 0.9em;
                }
                </style>
                <div class="ui text-1"><a> 
                 ]]..cc..[[ 
                  speed  ]]..cf..[[ 
                ]]..cg..[[ 
                 thrust  ]]..bv(20,c6)..' '..c7 ..'% ('..c2 ..[[) 
                </a></div>
                ]]end;local function cl()local cm={}local cn=1;local function co(cp,ar,by)local cq=cp and'■'or'-'local cr=by==nil and'['..cq..']'or'[</a><a class="'..by..'">'..cq..'</a><a>]'cm[cn]=cr..' '..ar;cn=cn+1 end;co(cu,ct,cs)if g~=nil and showShieldRelatedButtons then co(g.isActive(),'|SA:7| shield')co(g.isVenting(),'|A:1| vent',g.isVenting()and'yellow'or nil)co(h.getAutoRes(),'|A:2| auto resists')end;local cv=dampingOff==1 and'yellow'or nil;local cw='|A:3| '..(dampingOff==1 and'</a><a class="yellow">no damping</a><a>'or'no damping')co(dampingOff==1,cw,cv)if showAtmoRelatedButtons then co(autoLevel==1,'|A:4| auto-level')co(altitudeHold~=nil,altitudeHold==nil and'|A:5| altitude hold'or'|A:5| holding: '..W(altitudeHold))co(burnLimiter,'|A:6| burn limiter')end;co(landingMode,'| G | landing mode',landingMode and'red'or nil)co(groundStabilization,'|S:G| hover'..(groundStabilization and': '..W(b.getSurfaceEngineAltitudeStabilization())or''))co(showARCompass,'|A:8| AR marks')local cx=table.concat(cm,"\n")return[[
                <style>
                .text-2 {
                   position: absolute;
                   top: 73.5vh;
                   left: 64vw;
                   font-size: 0.8em;
                }
                </style>
                <div class="ui text-2"><a>]]..cx..[[</a></div>
                ]]end;local function cy(as)local constructVelocity=vec3(d.getWorldVelocity())local cz=vec3(e.getWorldGravity())local cA=constructVelocity:project_on(cz)local cB=math.floor(cA:len())if cA:dot(cz)>0 then cB=-cB end;local cC=d.getMaxBrake()local cD=bE()local c8=constructVelocity:len()local cE;if cC~=0 then cE=c8^2/(cC/cD)/2 else cE=0 end;local cF=c8~=0 and cE/c8*2 or 0;local cG=bV(cD)local cH=string.format('%-6s',W(cE))local cI=bQ(cF)if b.getAtmosphereDensity()==0 then local c5=d.getMaxThrustAlongAxis('space_engine',d.getForward())[3]local cJ=c8^2/((cC+c5)/cD)/2;local cK=c8~=0 and cJ/c8*2 or 0;cH=cH..' '..string.format('%-8s','('..W(cJ)..')')cI=cI..'  ('..bQ(cK)..')'else cH='   '..cH;cI='   '..cI end;local cL;if e.getAltitude()~=0 and as.closestBody.body.atmosphereThickness>0 then cL='burn speed: '..bO(d.getFrictionBurnSpeed())else cL='max speed:  '..bO(d.getMaxSpeed())end;return[[
                <style>
                .text-3 {
                   position: absolute;
                   top: 72.5vh;
                   left: 31vw;
                   font-size: 0.77em;
                }
                </style>
                <div class="ui text-3"><a>
                vert speed: ]]..cB..[[ m/s
                mass:       ]]..cG..[[ 
                ]]..cL..[[ 
                br dist: ]]..cH..[[ 
                br time: ]]..cI..[[ 
                </a></div>
                ]]end;local function cM()local function cN(cO)local cP=cO~=nil and json.decode(cO.getWidgetData())or{}local cQ=(cP.percentage~=nil and cP.percentage or 0)/100;local cR=a_(cQ*100)local cS=cP.timeLeft~=nil and(cP.timeLeft=='n/a'and-1 or cP.timeLeft)or-1;local cT=cS>=0 and bS(cS)or tostring(cR)..'%'return bv(10,cQ)..' '..cT end;local cU={}if j~=nil then cU[#cU+1]='atmo   '..cN(j)end;if l~=nil then cU[#cU+1]='space  '..cN(l)end;if m~=nil then cU[#cU+1]='rocket '..cN(m)end;local cV=table.concat(cU,"\n")return[[
                <style>
                .text-4 {
                   position: absolute;
                   top: 82vh;
                   left: 29vw;
                   font-size: 0.9em;
                }
                </style>
                <div class="ui text-4"><a>
                FUEL
                ]]..cV..[[
                </a></div>
                ]]end;local cW=""for ak=90,10,-10 do cW=cW..[[------- ]]..tostring(ak)..[[              ]]..tostring(ak)..[[ -------

                        --              --

                ]]end;cW=cW.."-------- 0              0 --------"for ak=-10,-90,-10 do cW=cW..[[ 

                        --              --

                ------ ]]..tostring(ak)..[[              ]]..tostring(ak)..[[ ------]]end;local function cX()local cY=t or 0;local cZ=s or 0;local c_=tostring((-cY+90)/180*100)return[[
                <style>
                .horizon-container {
                   position: absolute;
                   top: 77.5vh;
                   left: 41.25vw;
                   width: 21vw;
                   height: 13vh;
                   display: flex;
                   justify-content: center;
                   overflow: hidden;
                }
                .horizon {
                   font-size: 0.8em;
                   position: absolute;
                   top: 50%;
                   transform-origin: 50% ]]..c_..[[%;
                   transform: translate(0, -]]..c_..[[%) rotate(]]..tostring(-cZ)..[[deg);
                }
                .horizon-center {
                   font-size: 0.8em;
                   position: absolute;
                   top: 50%;
                   transform: translate(0, -50%);
                }
                </style>
                <div class="horizon-container">
                <div class="ui horizon-center"><a>\___   ___/
                /         \
                </a></div>
                <div class="ui horizon"><a>]]..cW..[[
                </a></div></div>
                ]]end;local function d0(aX)local b0=10;local d1={}local d2={' ','▄','█'}for U,d3 in ipairs(aX)do local d4={}local d5=math.floor(d3*b0)for U=1,d5 do table.insert(d4,d2[#d2])end;if d5<b0 then table.insert(d4,d2[math.floor(d3*b0%1*(#d2-1)+0.5)+1])end;for U=1,b0-d5+1 do table.insert(d4,d2[1])end;table.insert(d1,d4)end;local d6={}for ak=b0,1,-1 do local d4=''for al=1,#aX do d4=d4 ..d1[al][ak]end;table.insert(d6,d4)end;return d6 end;local function d7(d3)local d4={'','','','','','','','','',''}local d8=11-(math.floor(d3*9+0.5)+1)d4[d8]=math.floor(d3*100+0.5)..'%'return d4 end;local function d9(da,db)local d3={}for ak=1,#da,math.floor(#da/20)do table.insert(d3,da[ak])end;d3[#d3]=db;local dc=d0(d3)local dd=d7(db)return dc,dd end;local function de(bP)bP=bP or 5;local df={'|','/','|','\\'}local d8=math.floor(a.getUtcTime()*bP%#df)+1;return df[d8]end;local function dg()local dh=a.getUtcTime()local di=g.getShieldHitpoints()local dj=g.getMaxShieldHitpoints()local dk=di/dj;local dl=a_(dk*100)local dm=h.getShieldHistory()local dn=g.isVenting()local dp=''if dn then dp='yellow'elseif not g.isActive()then dp='red'end;local dq=''if dk<0.5 then dq='yellow'elseif dk<0.2 then dq='red'end;shieldStatusStr=g.isActive()and' ONLINE'or'OFFLINE'local ae,dd=d9(dm,dk)for ak=1,#ae do ae[ak]='</a><a class="'..dq..'">'..ae[ak]..'</a><a>'end;return[[
                <style>
                .shield-panel {
                    position: absolute;
                    top: 77vh;
                    left: 39.5vw;
                    font-size: 0.65em;
                }
                </style>
                <div class="ui shield-panel"><a>
                  ]]..string.format('%20s',bT(di))..[[ / ]]..string.format('%-21s',bT(dj))..[[ 
                     </a><a class="]]..dp..[[">SHIELD</a><a> |]]..ae[1]..[[| ]]..dd[1]..[[        
                    </a><a class="]]..dp..[[">]]..shieldStatusStr..[[</a><a> |]]..ae[2]..[[| ]]..dd[2]..[[ 
                            |]]..ae[3]..[[| ]]..dd[3]..[[ 
                            |]]..ae[4]..[[| ]]..dd[4]..[[ 
                            |]]..ae[5]..[[| ]]..dd[5]..[[ 
                            |]]..ae[6]..[[| ]]..dd[6]..[[ 
                            |]]..ae[7]..[[| ]]..dd[7]..[[ 
                            |]]..ae[8]..[[| ]]..dd[8]..[[ 
                            |]]..ae[9]..[[| ]]..dd[9]..[[ 
                            |]]..ae[10]..[[| ]]..dd[10]..[[           
                </a></div>]]end;local function dr()local ds=e.getMaxCoreStress()-e.getCoreStress()local dt=e.getMaxCoreStress()local du=dt>0 and ds/dt or 0;local dv=a_(du*100)local dw=''if du<0.5 then dw='yellow'elseif du<0.2 then dw='red'end;local dx=bv(20,du,dw)local dy=string.format('%-5s',dv..'%')local dn=g.isVenting()local dz=bX(g.getResistances(),g.getResistancesPool())local dA=g.getResistancesCooldown()local dB=g.getResistancesMaxCooldown()local dC=dA/dB;local dD=g.getVentingCooldown()local dE=g.getVentingMaxCooldown()local dF=dD/dE;local dG=h.getStressRatio()local dH=h.getAutoRes()local dI={}for ak,a3 in ipairs(dz)do dI[ak]=bv(12,a3,'blue')end;local dJ={}for ak,a3 in ipairs(dG)do dJ[ak]=bv(12,a3,'red')end;local dK=dH and''or'yellow'local dL='</a><a class="'..dK..'">'..h.getAutoResModeStr()..'</a><a>'local dM=bv(16,dC)local dN=string.format('%-11s',dA==0 and'READY'or bQ(dA))local dO=dn and bv(16,1,'yellow',de())or bv(16,dF)local dP=string.format('%-11s',dn and'IN PROGRESS'or(dD==0 and'READY'or bQ(dD)))return[[
                <style>
                .res-panel {
                    position: absolute;
                    top: 77vh;
                    left: 51vw;
                    font-size: 0.55em;
                }
                </style>
                <div class="ui res-panel"><a>   
                  ]]..string.format('%20s',bT(ds))..[[ / ]]..string.format('%-21s',bT(dt))..[[  
                        CCS ]]..dx..[[ ]]..string.format('%-11s',bT(dv)..'%')..[[  
                                                                        
                                 ]]..dI[2]..[[ 
                                 ]]..dJ[2]..[[ 
                                       EM
                    ]]..dI[1]..[[  AM    KI  ]]..dI[3]..[[ 
                    ]]..dJ[1]..[[     TH     ]]..dJ[3]..[[ 
                                 ]]..dI[4]..[[ 
                                 ]]..dJ[4]..[[ 
                    AUTO: ]]..dL..[[ 
                           RES ]]..dM..[[ ]]..dN..[[ 
                    |A:1| VENT ]]..dO..[[ ]]..dP..[[ 
                </a></div>]]end;local function dQ(as)local function dR(R)return R:gsub("Asteroid ","A"):gsub("Moon ","M"):sub(1,11)end;local bh=as.isPvP and'SAFE ZONE'or' PVP ZONE'return[[
                <style>
                .position-panel {
                    position: absolute;
                    top: 20vh;
                    left: 87vw;
                    font-size: 0.9em;
                }
                </style>
                <div class="ui position-panel"><a>
                 ___                ___
                |                      |
                |  ]]..bh..[[  ]]..string.format('%7s',W(as.PvpBorderDist))..[[  |

                  ]]..string.format('%11s',dR(as.closestBody.body.name[1]))..[[  ]]..string.format('%6s',W(as.closestBody.dist))..[[ 
                         atmo: ]]..string.format('%6s',W(as.closestBody.body.atmosphereThickness))..[[ 
                      gravity:  ]]..string.format('%.2fg',as.closestBody.body.gravity/9.80665)..[[ 
                  avg surface: ]]..string.format('%6s',W(as.closestBody.body.surfaceAverageAltitude))..[[ 
                  max surface: ]]..string.format('%6s',W(as.closestBody.body.surfaceMaxAltitude))..[[ 
                 
                 ]]..string.format('%11s',dR(as.closestPipe.body1.name[1]))..[[-]]..string.format('%-11s',dR(as.closestPipe.body2.name[1]))..[[ 
                |  PIPE        ]]..string.format('%7s',W(as.closestPipe.dist))..[[ |
                |___                ___|
                </a></div>
                ]]end;function n.onFlush()local function dS(dT,dU,dV)local dW=dT:cross(dV):normalize_inplace()local dX=math.acos(utils.clamp(dW:dot(-dU),-1,1))*constants.rad2deg;if dW:cross(-dU):dot(dV)<0 then dX=-dX end;return dX end;local dY=vec3(e.getWorldVertical())local dZ=vec3(d.getWorldOrientationForward())local d_=vec3(d.getWorldOrientationUp())local e0=vec3(d.getWorldOrientationRight())local e1=getRoll(dY,dZ,e0)s=e1 or 0;local e2=s/180*math.pi;local e3=math.cos(e2)local e4=math.sin(e2)local e5=dS(dY,dZ,e0*e3+d_*e4)t=utils.clamp(e5,-90,90)local e6=2;local e7=100/3.6;e6=math.max(e6,0.01)local e8=pitchInput+a.getControlDeviceForwardInput()local e9=rollInput+a.getControlDeviceYawInput()local ea=yawInput-a.getControlDeviceLeftRightInput()local eb=brakeInput;local dY=vec3(e.getWorldVertical())local cz=vec3(e.getWorldGravity())local constructPos=vec3(d.getWorldPosition())local ec=vec3(d.getWorldOrientationUp())local ed=vec3(d.getWorldOrientationForward()):normalize()local ee=vec3(d.getWorldOrientationRight())local constructVelocity=vec3(d.getWorldVelocity())local ef=constructVelocity:normalize()local c8=constructVelocity:len()local e1=getRoll(dY,ed,ee)local eg=math.abs(e1)local eh=utils.sign(e1)local cC=d.getMaxBrake()local cD=bE()u=Y(vec3(d.getWorldPosition()))curOrbit=at(constructPos,constructVelocity,u.closestBody.body)verticalSpeed=constructVelocity:project_on(cz):len()if cz:dot(constructVelocity)>0 then verticalSpeed=-verticalSpeed end;local ei=vec3(d.getWorldAngularVelocity())local ej;local ek=b.getAtmosphereDensity()local el=burnLimiterSpeed/3.6;if el==0 then el=d.getFrictionBurnSpeed()end;local em=0;if altitudeHold~=nil then local en=100;local eo=30;local ep=e.getAltitude()-altitudeHold;local eq=utils.clamp(ep/100,-1,1)local er=-en*eq;local es=er-verticalSpeed;local et=utils.clamp(es/en,-1,1)f.axisCommandManager:setThrottleCommand(axisCommandId.vertical,et*100)a.print(vec3(b.getEngineThrust('airfoil')):len()/cD/9.81)local c3=vec3(b.getEngineThrust('longitudinal')):len()local eu=c3/cD;local ev=5*et;if eu>0 then em=utils.clamp(math.asin(ev/eu)*constants.rad2deg,-eo,eo)end elseif landingMode and not manualVerticalInput then local es=targetLandingSpeed-verticalSpeed;if es>10 then eb=1 end;local et=utils.clamp(es/100,-1,1)f.axisCommandManager:setThrottleCommand(axisCommandId.vertical,et*100)end;local ew=30;if autoLevel==1 and e8==0 and e9==0 and s~=0 and t~=em then e9=utils.clamp(-s,-ew,ew)/ew;e8=utils.clamp(-t+em,-ew,ew)/ew;if math.abs(s)>90 then e8=-e8 end;ej=e8*ee+e9*ed+ea*ec elseif dampingOff==1 and e8==0 and e9==0 and ea==0 then ej=ei else ej=(e8*ee+e9*ed+ea*ec):normalize()*d.getMaxAngularSpeed()end;local ex=1;local ey=0;local ez=1;local eA=e6*(ej-ei)local eB=vec3(d.getWorldAirFrictionAngularAcceleration())eA=eA-eB;local eC=airfoilTorque and'airfoil'or''f:setEngineTorqueCommand('torque',eA,ex,eC,'','',ez)local eD=''local eE=vec3()local eF=false;local eG='thrust analog longitudinal'local eH=f.axisCommandManager:getAxisCommandType(axisCommandId.longitudinal)if eH==axisCommandType.byThrottle then local eI=f.axisCommandManager:composeAxisAccelerationFromThrottle(eG,axisCommandId.longitudinal)if burnLimiter then local eJ=(vec3(u.closestBody.body.center)-constructPos):normalize()local eK=constructVelocity:project_on(eJ):len()local eL=eJ:dot(ed)>0;local eM=eJ:dot(ef)>0;if eM then eK=-eK end;local eN=u.closestBody.body.atmosphereThickness>0 and eK<0 and curOrbit[2]<u.closestBody.body.atmosphereThickness;if ek>0.1 or ek>0 and t<0 then local eO=ef:dot(ed)>0;if c8>el then if eO then eI=vec3()end;eb=1 elseif c8>el-e7 then local eP=vec3(d.getWorldAirFrictionAcceleration())local eQ=(eP+cz:project_on(ef)):len()local eR=eQ/ed:project_on(ef):len()local eS=(el-c8-1/3.6)/e7;if eS<0 then eS=0 end;eR=eR+20*eS;if eO and eI:len()>eR then eI=eR*ed end end elseif eN and cC>0 then local eT=ef:project_on(eJ):len()local eU=u.closestBody.body.GM/u.closestBody.body.atmosphereRadius^2;local eV=cC/cD*eT-eU;if eV<=0 then eV=0.0001 end;local eW=el*eT;local eX=(eK^2-eW^2)/(2*eV)local eY=u.closestBody.dist-u.closestBody.body.atmosphereRadius;if-eK>eW and eX>=eY then if eL then eI=vec3()end;eb=1 end end end;f:setEngineForceCommand(eG,eI,ex)elseif eH==axisCommandType.byTargetSpeed then local eI=f.axisCommandManager:composeAxisAccelerationFromTargetSpeed(axisCommandId.longitudinal)eD=eD..' , '..eG;eE=eE+eI;if f.axisCommandManager:getTargetSpeed(axisCommandId.longitudinal)==0 or f.axisCommandManager:getCurrentToTargetDeltaSpeed(axisCommandId.longitudinal)<-f.axisCommandManager:getTargetSpeedCurrentStep(axisCommandId.longitudinal)*0.5 then eF=true end end;local eZ=eb*cC*-ef;if c8<5 then eZ=eb*-(30*constructVelocity+1*ef+cz)end;f:setEngineForceCommand('brake',eZ)local e_='thrust analog lateral'local f0=f.axisCommandManager:getAxisCommandType(axisCommandId.lateral)if f0==axisCommandType.byThrottle then local f1=f.axisCommandManager:composeAxisAccelerationFromThrottle(e_,axisCommandId.lateral)f:setEngineForceCommand(e_,f1,ex)elseif f0==axisCommandType.byTargetSpeed then local f2=f.axisCommandManager:composeAxisAccelerationFromTargetSpeed(axisCommandId.lateral)eD=eD..' , '..e_;eE=eE+f2 end;local f3='thrust analog vertical'local f4=f.axisCommandManager:getAxisCommandType(axisCommandId.vertical)if f4==axisCommandType.byThrottle then local f5=f.axisCommandManager:composeAxisAccelerationFromThrottle(f3,axisCommandId.vertical)f:setEngineForceCommand(f3,f5,ex,'airfoil','ground','',ez)elseif f4==axisCommandType.byTargetSpeed then local f6=f.axisCommandManager:composeAxisAccelerationFromTargetSpeed(axisCommandId.vertical)eD=eD..' , '..f3;eE=eE+f6 end;if eE:len()>constants.epsilon then if brakeInput~=0 or eF or math.abs(ef:dot(ed))<0.95 then eD=eD..', brake'end;f:setEngineForceCommand(eD,eE,ey,'','','',ez)end;f:setBoosterCommand('rocket_engine') end;local function f7()local f8=showARCompass and bu(u)..dQ(u)..b_()or''local bc=r..f8 ..bi(d,10^7)..c1()..cl()..cy(u)..cM()if showGuiOutline then bc=bc..c0()end;local cz=vec3(e.getWorldGravity()):len()if e.getAltitude()~=0 or g==nil then bc=bc..cX()else bc=bc..dg()..dr()end;return bc end;local function f9()a.setScreen(f7())end;function n.onUpdate()f9()end;return n end
                
                wtPilotHud = PilotHUDClass(system, unit, library, construct, core, Nav, shield, wtShield, db, atmofueltank_1, spacefueltank_1, rocketfueltank_1)

                weaponsPerPanel = 6 --export
                showGunnerAR = true --export
                
                function weaponClass(a,b,c)local d={}local e={}local f={}local g=0;c=c or 3;local function h()if not(type(b)=='table'and#b>0)then return end;local i;for j,k in ipairs(b)do if(j-1)%c==0 then i=a.createWidgetPanel('')end;local l=a.createData(k.getWidgetData())e[l]=k;a.addDataToWidget(l,a.createWidget(i,k.getWidgetType()))end end;local function m(e)return{["weaponStatus"]=e:match('"weaponStatus":(%d+)'),["animationTime"]=tonumber(e:match('"cycleAnimationRemainingTime":(.-),'))or 0,["fireReady"]=e:match('"fireReady":(.-),'),["outOfZone"]=e:match('"outOfZone":(.-),'),["targetConstructID"]=e:match('"constructId":"(.-)"'),["hitProb"]=math.floor((tonumber(e:match('"hitProbability":(%d%.%d+),'))or 0)*100)}end;local function n(o,f)if o["weaponStatus"]~=f["weaponStatus"]or o["fireReady"]~=f["fireReady"]or o["outOfZone"]~=f["outOfZone"]or o["targetConstructID"]~=f["targetConstructID"]or o["hitProb"]~=f["hitProb"]or o["animationTime"]>(f["animationTime"]or 0)then return true end;return false end;function d.onUpdate()for l,k in pairs(e)do local e=k.getWidgetData()local o=m(e)local p=n(o,f[l]or{})f[l]=o;local q=a.getUtcTime()if not p and q-g<1 then goto r end;g=q;local s=e:match('"ammoName":"(.-)"')local t=""if s:match("Antimatter")then t="AM"elseif s:match("Electromagnetic")then t="EM"elseif s:match("Kinetic")then t="KI"elseif s:match("Thermic")then t="TH"end;local u=""if s:match("Precision")then u="Prec"elseif s:match("Heavy")then u="Heavy"end;e=e:gsub('"ammoName":"(.-)"','"ammoName":"'..o["hitProb"]..'%% - '..t..' '..u..'"')e=e:gsub('"constructId":"(%d+(%d%d%d))","name":"(.?.?.?.?.?.?.?.?.?.?.?.?.?.?).-"','"constructId":"%1","name":"%2 - %3"')if not a.updateData(l,e)then a.print('wtWeapons update error')end::r::end end;h()return d end

                function radarClass(a,b,c,d,e,f,g)local h=require("dkjson")local i={}local j=50;local l=0.1;local m={['l']=true,['m']=true,['s']=true,['xs']=true}local n=false;local o=f or{}local p={}local q={}local r=0;local s={}local t={}local u={}local v={}local w={}local x;local y;local z=0;local A;i.counter={["total"]=0,["displayed"]=0,["allies"]=0,["enemies"]=0,["dead"]=0,["locked by"]=0,["attacked by"]=0,closest={},idents={},threats={}}i.lastEnemyContact=0;if g~=nil and g.hasKey('friendlist')then local B=0;for k,C in pairs(h.decode(g.getStringValue('friendlist')))do p[tonumber(k)]=C;B=B+1 end;a.print('Loaded '..B..' ids to friendlist from databank')end;if g~=nil and g.hasKey('deadCores')then local B=0;for k,C in pairs(h.decode(g.getStringValue('deadCores')))do q[tonumber(k)]=C;B=B+1 end;a.print('Loaded '..B..' ids to deadCores from databank')end;local D=false;local E=false;local F={}local G=m;local H=false;local I;local J={}local K=a.getScreenHeight()local L=a.getScreenWidth()local function M(N,O,P,Q,R)local S=400;local T=c.getPointOnScreen({O.x,O.y,O.z})if T[3]<=0 then return''end;local U=T[1]*L-S/2;local V=T[2]*K-S/2;svg=[[<svg viewBox="0 0 500 500" class="point" style="left:]]..U..[[px;top:]]..V..[[px;position:absolute;width:]]..S..[[px;height:]]..S..[[px">]]if N=='circle'then svg=svg..[[<circle cx="250" cy="250" r="10" opacity="0.3" stroke="]]..P..[[" stroke-width="2" fill="none"/>]]elseif N=='cross'then svg=svg..[[<line x1="250" y1="242" x2="250" y2="258" opacity="0.5"  stroke="]]..P..[[" stroke-width="2"/><line x1="242" y1="250" x2="258" y2="250" opacity="0.5"  stroke="]]..P..[[" stroke-width="2"/>]]elseif N=='box'then svg=svg..[[<rect x="240" y="240" width="20" height="20" style="fill: rgba(0,0,0,0); stroke: ]]..P..[[; stroke-width: 2"/>]]end;svg=svg..[[<text x="50%" y ="47%" style="text-anchor: middle; fill: ]]..P..[[; font-family: Arial, sans-serif; font-size: 14px;">]]..(Q or'')..[[</text><text x="50%" y ="55%" style="text-anchor: middle; fill: ]]..P..[[; font-family: Arial, sans-serif; font-size: 14px;">]]..(R or'')..[[</text></svg>]]return svg end;local function W(O,P,Q,R)return M('box',O,P,Q,R)end;local function X()I=a.createData(e.getWidgetData())a.addDataToWidget(I,a.createWidget(a.createWidgetPanel(''),e.getWidgetType()))end;local function Y()if g~=nil then g.setStringValue('deadCores',h.encode(q))a.print('saved deadCores to databank')end end;local function Z()local _={}local a0={}local a1={}local a2={}local a3={}local a4=e.getWidgetData()local a5=next(F)~=nil;local a6={["total"]=0,["displayed"]=0,["allies"]=0,["enemies"]=0,["dead"]=0,["locked by"]=0,["attacked by"]=0,idents={},threats={},closest={}}local a7=e.getConstructs(0,0)for a8,a9 in pairs(a7)do a6["total"]=a6["total"]+1;if a6["total"]%j==0 then coroutine.yield()end;local aa=a.getUtcTime()local ab=a9.constructId;local ac=a9.size;local ad=e.hasMatchingTransponder(ab)if ad then table.insert(_,ab)end;local ae=o[ab]==true or p[ab]==true or ad;local af=e.isConstructAbandoned(ab)if af then a6["dead"]=a6["dead"]+1;if q[ab]==nil and aa-10>r then r=aa;local ag=e.getConstructWorldPos(ab)q[ab]=ag;Y()local ah='Dead core: '..a9.name..' ('..ab..') at '..'::pos{0,0,'..ag[1]..','..ag[2]..','..ag[3]..'}'a.print(ah)end elseif ae then if#a6.closest<8 then table.insert(a6.closest,ab)end;a6["allies"]=a6["allies"]+1 else if#a6.closest<8 then table.insert(a6.closest,ab)end;a6["enemies"]=a6["enemies"]+1 end;local ai=e.getThreatRateFrom(ab)if ai=='identified'then table.insert(a6.threats,ab)a6["locked by"]=a6["locked by"]+1 elseif ai=='attacked'then table.insert(a6.threats,ab)a6["attacked by"]=a6["attacked by"]+1 end;if e.isConstructIdentified(ab)then table.insert(a6.idents,ab)end;if e.getThreatRateFrom(ab)<3 and F[ab%1000]~=true and ab~=e.getTargetId()then if not D and not G[ac:lower()]then goto aj end;if ae~=n then goto aj end;if not D and a5 and F[ab%1000]~=true then goto aj end;if D and not e.isConstructIdentified(ab)then goto aj end end;a9.name=string.format("%03d",ab%1000)..' - '..a9.name;str=h.encode(a9)if not H then table.insert(a0,str)elseif ac=="L"then table.insert(a0,str)elseif ac=="M"then table.insert(a1,str)elseif ac=="S"then table.insert(a2,str)elseif ac=="XS"then table.insert(a3,str)end;a6["displayed"]=a6["displayed"]+1::aj::end;if i.counter["enemies"]==0 and a6["enemies"]>0 then a.playSound("wthud/radarContact.mp3")elseif a6["enemies"]==0 and i.counter["enemies"]>0 then a.playSound("wthud/radarClear.mp3")end;if i.counter["enemies"]<a6["enemies"]then i.lastEnemyContact=a.getUtcTime()end;i.counter=a6;local ak={}for al,am in pairs(G)do if am then table.insert(ak,al:upper())end end;table.sort(ak)local an=(a6["displayed"]..'/'..a6["total"]..' ')..(a5 and'FOCUS 'or'')..(n and'Friends'or'Enemies')..(D and' - LOCKED'or'')..' ('..table.concat(ak,",")..')'local ao=a4:match('"elementId":".+')local ap=e.getTargetId()if g~=nil then if e.isConstructIdentified(ap)then g.setIntValue('targetSpeed',math.floor(e.getConstructSpeed(ap)))else g.setIntValue('targetSpeed',-1)end end;ao=ao:gsub('"errorMessage":""','"errorMessage":"'..an..'"')local aq=''local ar=false;if#a0>0 then aq=aq..table.concat(a0,",")ar=true end;if#a1>0 then if ar then aq=aq..','end;aq=aq..table.concat(a1,",")ar=true end;if#a2>0 then if ar then aq=aq..','end;aq=aq..table.concat(a2,",")ar=true end;if#a3>0 then if ar then aq=aq..','end;aq=aq..table.concat(a3,",")end;a4='{"constructsList":['..aq.."],"..ao;a.updateData(I,a4)J=_ end;local function as()while true do Z()coroutine.yield()end end;local at=coroutine.create(as)local function au(av)local aw=av;while true do aw,k=string.gsub(aw,"^(-?%d+)(%d%d%d)",'%1,%2')if k==0 then break end end;return aw end;local function ax(ay)if ay==nil then return''end;ay=ay*3.6;return au(math.floor(ay))..' km/h'end;local function az(aA)if e.isConstructIdentified(aA)then return ax(vec3(e.getConstructWorldVelocity(aA)):len())end;return ax(s[aA])end;local function aB(aA)local aC=e.getConstructOwnerEntity(aA)if aC.isOrganization then return' '..a.getOrganization(aC.id).tag else return' '..a.getPlayerName(aC.id)end end;function i.onFlush()local aa=a.getUtcTime()for aD,aE in ipairs(J)do local O=vec3(e.getConstructWorldPos(aE))if u[aE]==nil then u[aE]={O,aa}end;if O~=u[aE][1]then v[aE]=u[aE]u[aE]={O,aa}if w[aE]==nil then w[aE]=u[aE]end;if t[aE]==nil or aa-t[aE]>1 then t[aE]=aa;s[aE]=(u[aE][1]-w[aE][1]):len()/(u[aE][2]-w[aE][2])w[aE]=u[aE]end end end;local ap=e.getTargetId()if ap==x then local aF=e.getConstructDistance(ap)if y==nil then y={aF,aa}elseif aF~=y[1]and aa-y[2]>1 then A=(y[1]-aF)/(aa-y[2])y={aF,aa}end else y=nil;A=nil end;x=ap end;function i.getHUD()local aG=''if not showGunnerAR then return aG end;local aa=a.getUtcTime()for aD,aE in ipairs(J)do local O=vec3(e.getConstructWorldPos(aE))if v[aE]~=nil then O=u[aE][1]+(u[aE][1]-v[aE][1]):normalize()*(aa-u[aE][2])*(u[aE][1]-v[aE][1]):len()/(u[aE][2]-v[aE][2])end;if O then local P="#0cf27b"if e.getThreatRateFrom(aE)>2 then P="#FF5B72"end;aG=aG..W(O,P,aE%1000 ..aB(aE),az(aE))end end;local aH=vec3(d.getWorldPosition())for aE,ag in pairs(q)do local ag=vec3(ag)local aI=(vec3(ag)-aH):len()if aI>400000 then aG=aG..W(ag,"#ccc",aE%1000,string.format('%0.2f',aI/200000)..' su')end end;return aG end;function i.getTargClosingSpeed()return A end;function i.onTick()coroutine.resume(at)end;function i.clearIDFilter()F={}end;function i.addIDFilter(aJ)F[aJ]=true end;local function aK()if g~=nil then g.setStringValue('friendlist',h.encode(p))a.print('saved friendlist to databank')end end;function i.onTextInput(aL)aL=string.lower(aL)if aL:match('^f%A*$')~=nil then i.clearIDFilter()for aJ in aL:gmatch('%D(%d%d%d)')do i.addIDFilter(tonumber(aJ))end elseif aL:match('^%d%d%d$')~=nil then i.clearIDFilter()i.addIDFilter(tonumber(aL:match('^(%d%d%d)$')))elseif aL:match('^s[sh]?%s?x?[sml]?$')~=nil then local aM,al=aL:match('^s([sh]?)%s?(x?[sml]?)$')local aN;if aM==nil or aM==''then G=m;return elseif aM=='s'then aN=true elseif aM=='h'then aN=false end;if al==nil then return end;G[al]=aN elseif aL:match('^addall')~=nil then for aD,aJ in ipairs(e.getConstructIds())do p[aJ]=true;a.print('Adding '..aJ..' to friendlist')end;aK()elseif aL:match('^addid')~=nil then for aJ in aL:gmatch('%D(%d+)')do p[tonumber(aJ)]=true end;aK()elseif aL:match('^clearall$')~=nil then p={}aK()elseif aL:match('^cleardead')~=nil then local aO=true;for aJ in aL:gmatch('%D(%d%d%d)')do aO=false;for aP,aD in pairs(q)do if aP%1000==tonumber(aJ)then q[aP]=nil end end;i.addIDFilter(tonumber(aJ))end;if aO then q={}end;Y()end end;function i.toggleFriendlyMode()n=not n end;function i.toggleOnlyIdentified()D=not D end;function i.toggleGunnerMode()E=not E end;X()b.setTimer('wtRadarTick',l)return i end

                function damageReporterClass(a,b,c)local d={}if c==nil then c=10 end;if a==nil then a=1 end;if b==nil then b=60 end;local e=b+c+5;local f=50000;local g;local h=""local function i()g={peakDps=0,damageDealt=0,damageDealtById={},damageDealtHistory={},damageRecievedHistory={},shotsHit=0,shotsFired=0}for j=1,e do g.damageDealtHistory[#g.damageDealtHistory+1]=0;g.damageRecievedHistory[#g.damageRecievedHistory+1]=0 end end;i()local function k(l)table.remove(l,1)l[#l+1]=0 end;local function m(n,o,p)p=p or f;local function q(r,s,t)local u={}for j=0,t-1 do local v=0;for w=0,s-1 do v=v+r[#r-j-w]end;local x=v/s;u[t-j]=x;if x>p then p=x end end;return u end;local function y(r,t)local v=0;for j=#r,#r-t+1,-1 do v=v+r[j]end;return v/t end;local z=200;local A=100;local B=30;local C=30;p=p or 50000;local function D(E)local F={}for j,r in ipairs(E)do local G=(1-math.min(r/p,1))*A+C;local H=(j-1)/(#E-1)*z+B;table.insert(F,{x=H,y=G})end;return F end;local I=c;local J=b;local K=q(n,I,J)local L=K[#K]local M=q(o,I,J)local N=M[#M]local O=y(n,J)local P=y(o,J)local Q=(1-O/p)*A+C;local R=(1-P/p)*A+C;local S=D(K)local T=D(M)local function U(V,W)local X=''local Y;for Z,_ in ipairs(V)do X=X..'<circle class="'..W..'" cx="'.._.x..'" cy="'.._.y..'" r="1"/>'if Y~=nil then X=X..'<line class="'..W..'" x1="'.._.x..'" y1="'.._.y..'" x2="'..Y.x..'" y2="'..Y.y..'" />'end;Y=_ end;return X end;local function a0(a1)return string.format('%.1fk',a1/1000)end;local a2=[[
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     width="260px" height="160px" viewBox="0 0 260 160" xml:space="preserve">
                    <rect class="outd" x="29" y="129" width="202" height="2"/>
                    <rect class="outd"  x="29" y="29" width="2" height="102"/>
                ]]if O>0 then a2=a2 ..U(S,'ind')a2=a2 ..'<line class="ind" stroke-width="0.5" x1="28" y1="'..Q..'" x2="228" y2="'..Q..'" stroke-dasharray="5" stroke-dashoffset="7.5"/><text class="ind text" font-size="11" text-anchor="end" x="27" y="'..Q..'">'..a0(O)..'</text>'end;if P>0 then a2=a2 ..U(T,'outd')a2=a2 ..'<line class="" stroke="#cfc" stroke-opacity="0.5" stroke-width="1" x1="28" y1="'..R..'" x2="228" y2="'..R..'" stroke-dasharray="5" stroke-dashoffset="7.5"/><text class="outd text" font-size="11" text-anchor="end" x="27" y="'..R..'">'..a0(P)..'</text>'end;if N>0 then a2=a2 ..'<text class="outd text" font-size="11" x="233" y="'..T[#T].y..'">'..a0(N)..'</text>'end;if L>0 then a2=a2 ..'<text class="ind text" font-size="11" x="233" y="'..S[#S].y..'">'..a0(L)..'</text>'end;a2=a2 ..'</svg>'return a2 end;function d.weaponOnHit(a3,a4)g.damageDealt=g.damageDealt+a4;g.damageDealtById[a3]=(g.damageDealtById[a3]or 0)+a4;g.shotsHit=g.shotsHit+1;g.shotsFired=g.shotsFired+1;g.damageDealtHistory[#g.damageDealtHistory]=g.damageDealtHistory[#g.damageDealtHistory]+a4 end;function d.weaponOnMiss(a3)g.shotsFired=g.shotsFired+1 end;function d.onDamage(a5)g.damageRecievedHistory[#g.damageRecievedHistory]=g.damageRecievedHistory[#g.damageRecievedHistory]+a5 end;function d.onPvPTimer(a6)if a6==0 then i()end end;function d.onTimer()local a7=0;for j=e,e-c,-1 do a7=a7+g.damageDealtHistory[j]end;local a8=a7/c;if a8>g.peakDps then g.peakDps=a8 end;h=m(g.damageRecievedHistory,g.damageDealtHistory)k(g.damageDealtHistory)k(g.damageRecievedHistory)end;h=m(g.damageRecievedHistory,g.damageDealtHistory)unit.setTimer('weaponStats',a)function d.getDamageStats()return g end;function d.getDpsGraphHtml()return h end;return d end

                wtWeapons = weaponClass(system, weapon, weaponsPerPanel)
                wtRadar = radarClass(system, unit, library, construct, radar_1, {}, db_1)
                dpsReporter = damageReporterClass()

                local a="black"local b="#b6dbe7"local c="1"local d=[[
                <style>
                .ui {
                    color: ]]..b..[[;
                    font: Inconsolata, monospace;
                    font-family: monospace;
                    font-size: 0.75em;
                    font-weight: bold;
                    opacity: ]]..c..[[;
                    white-space: pre;
                    text-shadow: -1px -1px 0 ]]..a..[[, 1px -1px 0 ]]..a..[[, -1px 1px 0 ]]..a..[[, 1px 1px 0 ]]..a..[[;
                }
                .blue {
                    color: #5BD8FF;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                .red {
                    color: #FF5B72;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                .orange {
                    color: #fc934f;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                .yellow {
                    color: #fce94f;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                .green {
                    color: #72ff5b;
                     text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
                }
                </style>
                ]]local function e(f)return math.max(math.min(50000/3.6,50000/3.6-10713*(f-10000)/(853926+f-10000)),20000/3.6)end;local function g(h,i,j,l)local m='-'l=l or'█'local n=math.floor(math.min(math.abs(math.max(i-1,0)),1)*h+0.5)local o=math.floor(math.min(math.abs(i),1)*h+0.5)local p;if i>=0 then p='[</a><a class="'..(j or'')..'">'..string.rep(l,o-n)..'</a><a class="red">'..string.rep(l,n)..'</a><a>'..string.rep(m,h-o)..']'elseif i<0 then p='['..string.rep(m,h-o)..'</a><a class="red">'..string.rep(l,o).."</a><a>]"else p='[</a><a class="red">'..string.rep('X',h).."</a><a>]"end;return p end;local function q(r)if r<1000 then return math.ceil(r)..'m'elseif r<1000*10 then return string.format("%.2fkm",r/1000)elseif r<1000*100 then return string.format("%.1fkm",r/1000)elseif r<1000*200*10 then return string.format("%.2fsu",r/1000/200)elseif r<1000*200*100 then return string.format("%.1fsu",r/1000/200)else return math.ceil(r/1000/200)..'su'end end;local function s(t,u,v)if t>u+v*2 then return'red'elseif t>u+v then return'orange'elseif t>u then return'yellow'else return''end end;local function w(x)local y=x;while true do y,k=string.gsub(y,"^(-?%d+)(%d%d%d)",'%1,%2')if k==0 then break end end;return y end;local function z(A)if A==nil then return''end;A=A*3.6;return w(math.floor(A))..' km/h'end;local function B(A)A=A or 5;local C={'|','/','|','\\'}local D=math.floor(system.getUtcTime()*A%#C)+1;return C[D]end;local function E(F)if F<1000 then return math.floor(F)elseif F<1000*10 then return string.format("%.2fk",F/1000)elseif F<1000*100 then return string.format("%.1fk",F/1000)elseif F<1000*1000*10 then return string.format("%.2fm",F/1000000)elseif F<1000*200*100 then return string.format("%.1fm",F/1000000)else return math.ceil(F/1000000)..'m'end end;local function G(h,H)local I=(h-#H)/2;local J=math.floor(I)local K=math.ceil(I)local L=string.rep(' ',J)..H..string.rep(' ',K)return L end;local function M()return radar_1 end;local function N()activeRadar=M()if wtRadar==nil then return''end;local function O(P)if activeRadar.getThreatRateFrom(P)>2 then return'red'elseif activeRadar.hasMatchingTransponder(P)then return'green'else return''end end;local function Q(P)return string.format('%2s',activeRadar.getConstructCoreSize(P))end;local function R(P)local S=activeRadar.getConstructOwnerEntity(P)if S==nil then return''end;local T;if S.isOrganization then T=system.getOrganization(S.id).tag or''else T=system.getPlayerName(S.id)or''end;return T:sub(1,4)end;local function U(P)if P==nil then return string.rep(' ',19)end;return'</a><a class="'..O(P)..'">'..Q(P)..' '..string.format('%03d',P%1000)..' '..string.format('%-6s',q(activeRadar.getConstructDistance(P)))..'  '..string.format('%-4s',R(P))..'</a><a>'end;local function V(P)if P==nil then return string.rep(' ',11)end;return string.format('%-11s',z(activeRadar.getConstructSpeed(P)))end;local W=''if wtRadar.counter["attacked by"]>0 then W='red'end;return[[
                <style>
                .contacts-panel {
                    position: absolute;
                    top: 2vh;
                    left: 38vw;
                    font-size: 0.7em;
                }
                </style>
                <div class="ui contacts-panel"><a>
                 ___]]..G(37,'CONTACTS '..string.format('%-5d',wtRadar.counter["total"]))..[[___
                |     ENEMIES ]]..string.format('%-5d',wtRadar.counter["enemies"])..[[   |    </a><a class="]]..W..[[">ATTACKING  ]]..string.format('%-5d',wtRadar.counter["attacked by"])..[[</a><a> |
                |      ALLIES ]]..string.format('%-5d',wtRadar.counter["allies"])..[[   |     THREATS   ]]..string.format('%-5d',wtRadar.counter["locked by"]+wtRadar.counter["attacked by"])..[[ | 
                |                     |                     |
                  ]]..U(wtRadar.counter.closest[1])..[[ | ]]..U(wtRadar.counter.threats[1])..[[ 
                  ]]..U(wtRadar.counter.closest[2])..[[ | ]]..U(wtRadar.counter.threats[2])..[[ 
                  ]]..U(wtRadar.counter.closest[3])..[[ | ]]..U(wtRadar.counter.threats[3])..[[ 
                  ]]..U(wtRadar.counter.closest[4])..[[ | ]]..U(wtRadar.counter.threats[4])..[[ 
                  ]]..U(wtRadar.counter.closest[5])..[[ | ]]..U(wtRadar.counter.threats[5])..[[ 
                  ]]..U(wtRadar.counter.closest[6])..[[ | ]]..U(wtRadar.counter.threats[6])..[[ 
                | ]]..U(wtRadar.counter.closest[7])..[[ | ]]..U(wtRadar.counter.threats[7])..[[ |
                | ]]..U(wtRadar.counter.closest[8])..[[ | ]]..U(wtRadar.counter.threats[8])..[[ |
                |___]]..string.rep(' ',37)..[[___|
                </a></div>
                ]]end;function getGunnerHudHtml()local X=d;local activeRadar=M()local Y=0;local Z=0;local _=0;local a0=0;local a1=ammoCont_1~=nil and ammoCont_1.getItemsVolume()/ammoCont_1.getMaxVolume()or 0;local a2=g(14,a1)local a3=math.floor(a1*100+0.5)local a4=dpsReporter.getDamageStats()local a5=string.format('%-4s',a4.shotsFired>0 and math.floor(a4.shotsHit/a4.shotsFired*100+0.5)..'%'or'0')local a6={}for a7=1,6 do a6[a7]=string.rep(' ',34)end;if(weapon_size or 0)>0 then local a8=0;for a7,a9 in ipairs(weapon)do a8=a8+a9.getHitProbability()local aa=a9.getWidgetData()local ab=a9.getMaxAmmo()>0 and a9.getAmmoCount()/a9.getMaxAmmo()or 0;local ac=a9.getStatus()local ad=a9.getOperationalState()~=1;local ae=''local af,l;if ad then af='BROKEN'ae='red'elseif ac==4 then af='RELOADING'ae='yellow'l=B()ab=1 elseif ac==5 then af='UNLOADING'ae='yellow'l=B()ab=1 elseif ab==0 then af='RELOAD'ae='red'elseif ac==6 then af='BLOCKED'ae='red'elseif ab<=0.1 then af='LOW AMMO'ae='yellow'elseif ac==2 then af='FIRING'elseif ac==1 then af='IDLE'else af='ERROR'ae='red'end;local ag='</a><a class="'..ae..'">'..a9.getClass():match('Weapon(.)')..'</a><a>'local af='</a><a class="'..ae..'">'..string.format('%-9s',af)..'</a><a>'local ah=g(20,ab,ae,l)a6[a7]=ag..' '..ah..' '..af end;Y=a8/weapon_size;Z=weapon[1].getOptimalTracking()_=weapon[1].getOptimalDistance()a0=(weapon[1].getMaxDistance()-weapon[1].getOptimalDistance())/2 end;local ai=activeRadar.getTargetId()if ai~=0 then local aj=activeRadar.getConstructAngularSpeed(ai)*180/math.pi;local ak=wtRadar.getTargClosingSpeed()local al=activeRadar.getConstructSpeed(ai)local am=activeRadar.getConstructName(ai)local an=activeRadar.getConstructMass(ai)local ao=activeRadar.getConstructCoreSize(ai)local ap=activeRadar.isConstructAbandoned(ai)local aq=activeRadar.getConstructDistance(ai)local ar=e(an)local as=0;local at=activeRadar.isConstructIdentified(ai)local au=at and string.rep(' ',12)or'</a><a class="red">UNIDENTIFIED</a><a>'local av=string.format('%4s','['..ao..']')local aw=string.format('%03d',ai%1000)local ax=string.format('%-17s',am:sub(1,17))local ay=ap and'</a><a class="red">DEAD</a><a>'or'    'local az=string.format('%4s',math.floor(Y*100+0.5)..'%')..' '..g(18,Y)local aA=s(aj,Z,Z)local aB=at and'</a><a class="'..aA..'">'..string.format('%3d',math.ceil(aj))..'</a><a> deg/s'or string.rep(' ',9)local aC=s(aq,_,a0)local aD='</a><a class="'..aC..'">'..string.format('%6s',q(aq))..'</a><a>'local aE=string.format('%12s',z(ak))local aF=at and string.format('%11s',z(al))or string.rep(' ',11)local aG=at and string.format('%11s',z(ar))or string.rep(' ',11)X=X..[[
                <style>
                .target-panel {
                    position: absolute;
                    top: 56vh;
                    left: 28vw;
                    font-size: 0.69em;
                }
                </style>
                <div class="ui target-panel"><a>
                 ___ ]]..av..[[ ]]..aw..[[ - ]]..ax..[[ ___
                |               ]]..ay..[[                 | 
                | hit prob ]]..az..[[ |
                             ]]..au..[[             
                             |  TARGET   |  OPTIMAL  
                    angular  | ]]..aB..[[ | ]]..string.format('%-9s',math.floor(Z)..' deg/s')..[[ 
                   distance  |   ]]..aD..[[  | ]]..string.format('%6s',q(_))..[[ 
                  -----------|-----------|---------- 
                  closing at |    ]]..aE..[[   
                       speed |     ]]..aF..[[  
                |  max speed |     ]]..aG..[[       |
                |___  damage |          ]]..string.format('%-7s',E(a4.damageDealtById[ai]or 0))..[[   ___|
                </a></div>

                ]]end;X=X..[[
                <style>
                .weapon-panel {
                    position: absolute;
                    top: 62vh;
                    left: 62vw;
                    font-size: 0.55em;
                }
                </style>
                <div class="ui weapon-panel"><a>
                 ___                               ___ 
                |            WEAPON STATUS            |
                |  ]]..a6[1]..[[ |
                   ]]..a6[2]..[[   
                   ]]..a6[3]..[[  
                   ]]..a6[4]..[[  
                   ]]..a6[5]..[[  
                |  ]]..a6[6]..[[ |
                |___  AMMO ]]..a2 ..[[        ___|
                </a></div>
                <style>
                .stats-panel {
                    position: absolute;
                    top: 3vh;
                    left: 54vw;
                    font-size: 0.7em;
                }
                </style>
                <div class="ui stats-panel"><a>
                   SHOTS FIRED   ]]..string.format('%-7s',tostring(a4.shotsFired))..[[ 
                   SHOTS HIT     ]]..string.format('%-7s',tostring(a4.shotsHit))..[[ 
                   ACCURACY      ]]..string.format('%-7s',a5)..[[ 
                   PEAK DPS      ]]..string.format('%-7s',E(a4.peakDps))..[[ 
                   DAMAGE        ]]..string.format('%-7s',E(a4.damageDealt))..[[ 
                </a></div>
                ]]X=X..[[
                <style>
                .dps-panel {
                    position: absolute;
                    top: 3vh;
                    left: 64vw;
                    font-size: 0.75em;
                }
                .outd{
                    stroke-width: 1;
                    stroke: ]]..a..[[;
                    stroke-opacity: 0.3;
                    fill-opacity: ]]..c..[[;
                    fill: ]]..b..[[;
                }
                .ind{
                    stroke-width: 1;
                    stroke: #FF5B72;
                    stroke-opacity: 0.3;
                    fill-opacity: 0.75;
                    fill: #fff;
                }
                .text{
                    stroke-width: 1;
                    font-size: 8;
                }
                </style>
                <div class="dps-panel">
                ]]..dpsReporter.getDpsGraphHtml()..[[
                </div>
                ]]X=X..N()X=X..[[
                <style>
                body {
                    box-shadow: inset 0 0 800px 0px rgba(255,0,0,]]..1-system.getUtcTime()+wtRadar.lastEnemyContact..[[)
                }
                </style>
                ]]return X end

                system.showScreen(1)

                local function getHTML()
                    return getGunnerHudHtml() .. wtRadar.getHUD() .. wtPilotHud.getHudHTML()
                end

                function updateHud()
                    system.setScreen(getHTML())
                end
    
        onTimer:
            args: ["wtShieldTick"]
            lua: |
                wtShield.onTick()
        onTimer:
            args: ["wtRadarTick"]
            lua: |
                wtRadar.onTick()
        onTimer:
            args: ["weaponStats"]
            lua: |
                dpsReporter.onTimer()
    construct:
        onPvPTimer(active):
            lua: |
                dpsReporter.onPvPTimer(active)
    core:
        onStressChanged(stress):
            lua: |
                dpsReporter.onDamage(stress)
    system:
        onUpdate:
            lua: |
                Nav:update()
                updateHud()
                wtWeapons.onUpdate()
                wtMonitor.onUpdate()
        onFlush:
            lua: |
                local ok, msg = xpcall(wtPilotHud.onFlush, traceback)
                if not ok then
                  system.print(msg:gsub("\n", "<br>"))
                end
                wtRadar.onFlush()
        actionStart:
            args: [forward]
            lua: pitchInput = pitchInput - 1
        actionStop:
            args: [forward]
            lua: pitchInput = pitchInput + 1
        actionStart:
            args: [backward]
            lua: pitchInput = pitchInput + 1
        actionStop:
            args: [backward]
            lua: pitchInput = pitchInput - 1
        actionStart:
            args: [left]
            lua: rollInput = rollInput - 1
        actionStop:
            args: [left]
            lua: rollInput = rollInput + 1
        actionStart:
            args: [right]
            lua: rollInput = rollInput + 1
        actionStop:
            args: [right]
            lua: rollInput = rollInput - 1
        actionStart:
            args: [yawright]
            lua: yawInput = yawInput - 1
        actionStop:
            args: [yawright]
            lua: yawInput = yawInput + 1
        actionStart:
            args: [yawleft]
            lua: yawInput = yawInput + 1
        actionStop:
            args: [yawleft]
            lua: yawInput = yawInput - 1
        actionStart:
            args: [brake]
            lua: |
                if laltInput then
                    brakeLock = not brakeLock
                else
                    brakeLock = false
                end

                brakeInput = 1
        actionStop:
            args: [brake]
            lua: |
                if not brakeLock then
                    brakeInput = 0
                end
        actionStart:
            args: [gear]
            lua: |
                if lshiftInput then
                    if groundStabilization then
                        groundStabilization = false
                        Nav.axisCommandManager:deactivateGroundEngineAltitudeStabilization()
                    else
                        groundStabilization = true
                        Nav.axisCommandManager:activateGroundEngineAltitudeStabilization()
                    end
                elseif landingMode then
                    landingMode = false
                    unit.retractLandingGears()
                    if defaultHoverAltitude > 0 then
                        groundStabilization = true
                        Nav.axisCommandManager:activateGroundEngineAltitudeStabilization()
                        Nav.axisCommandManager:setTargetGroundAltitude(defaultHoverAltitude)
                    end
                    Nav.axisCommandManager:resetCommand(axisCommandId.vertical)
                else
                    landingMode = true
                    altitudeHold = nil
                    unit.deployLandingGears()
                    Nav.axisCommandManager:deactivateGroundEngineAltitudeStabilization()
                    groundStabilization = false
                end
        actionStart:
            args: [booster]
            lua: Nav:toggleBoosters()
        actionStart:
            args: [stopengines]
            lua: |
                if unit.getThrottle() == 0 then
                    Nav.axisCommandManager:setThrottleCommand(axisCommandId.longitudinal, 100)
                else
                    Nav.axisCommandManager:setThrottleCommand(axisCommandId.longitudinal, 0)
                end
        actionLoop:
            args: [speedup]
            lua: Nav.axisCommandManager:updateThrottleCommand(axisCommandId.longitudinal, 0.05)
        actionLoop:
            args: [speeddown]
            lua: Nav.axisCommandManager:updateThrottleCommand(axisCommandId.longitudinal, -0.05)
        actionStart:
            args: [lalt]
            lua: |
                laltInput = true
        actionStop:
            args: [lalt]
            lua: |
                laltInput = false
        actionStart:
            args: [option1]
            lua: |
                if shield.isVenting() then
                    shield.stopVenting()
                else
                    shield.startVenting()
                end
        actionStart:
            args: [option2]
            lua: |
                wtShield.toogleAutoRes()
        actionStart:
            args: [option3]
            lua: |
                dampingOff = 1 - dampingOff
        actionStart:
            args: [option4]
            lua: |
                if altitudeHold == nil then
                    autoLevel = 1 - autoLevel
                end
        actionStart:
            args: [option5]
            lua: |
                local curAlt = core.getAltitude()
                if altitudeHold == nil then
                    altitudeHold = curAlt
                    autoLevel = 1
                else
                    altitudeHold = nil
                    autoLevel = 0
                    Nav.axisCommandManager:resetCommand(axisCommandId.vertical)
                end
        actionStart:
            args: [option6]
            lua: |
                burnLimiter = not burnLimiter
        actionStart:
            args: [option7]
            lua: |
                if lshiftInput then 
                    shield.toggle()
                end
        actionStart:
            args: [option8]
            lua: |
                showARCompass = not showARCompass
        actionStart:
            args: [option9]
            lua: |
                showGunnerAR = not showGunnerAR
        actionStart:
            args: [lshift]
            lua: |
                lshiftInput = true
        actionStop:
            args: [lshift]
            lua: |
                lshiftInput = false
                if manualResToApply then 
                    wtShield.manualOverride(manualResToApply)
                    manualResToApply = nil
                end
        actionStart:
            args: [strafeleft]
            lua: |
                if lshiftInput then
                    if not manualResToApply then manualResToApply = {0,0,0,0} end
                    manualResToApply[1] = manualResToApply[1] + 1
                else
                    Nav.axisCommandManager:updateCommandFromActionStart(axisCommandId.lateral, -1.0)
                end
        actionStop:
            args: [strafeleft]
            lua: |
                if unit.getAxisCommandValue(1) == -1 then
                    Nav.axisCommandManager:updateCommandFromActionStop(axisCommandId.lateral, 1.0)
                end
        actionStart:
            args: [up]
            lua: |
                if lshiftInput then
                    if not manualResToApply then manualResToApply = {0,0,0,0} end
                    manualResToApply[2] = manualResToApply[2] + 1
                else
                    manualVerticalInput = true
                    Nav.axisCommandManager:setThrottleCommand(axisCommandId.vertical, 0)
                    Nav.axisCommandManager:deactivateGroundEngineAltitudeStabilization()
                    Nav.axisCommandManager:updateCommandFromActionStart(axisCommandId.vertical, 1.0)
                end
        actionLoop:
            args: [up]
            lua: |
                if altitudeHold ~= nil then
                    altitudeHold = altitudeHold + 10
                end
        actionStop:
            args: [up]
            lua: |
                manualVerticalInput = false
                if unit.getAxisCommandValue(2) == 1 then
                    Nav.axisCommandManager:updateCommandFromActionStop(axisCommandId.vertical, -1.0)
                end
                if groundStabilization then
                    Nav.axisCommandManager:activateGroundEngineAltitudeStabilization()
                end
        actionStart:
            args: [straferight]
            lua: |
                if lshiftInput then
                    if not manualResToApply then manualResToApply = {0,0,0,0} end
                    manualResToApply[3] = manualResToApply[3] + 1
                else
                    Nav.axisCommandManager:updateCommandFromActionStart(axisCommandId.lateral, 1.0)
                end
        actionStop:
            args: [straferight]
            lua: |
                if unit.getAxisCommandValue(1) == 1 then
                    Nav.axisCommandManager:updateCommandFromActionStop(axisCommandId.lateral, -1.0)
                end
        actionStart:
            args: [down]
            lua: |
                if lshiftInput then
                    if not manualResToApply then manualResToApply = {0,0,0,0} end
                    manualResToApply[4] = manualResToApply[4] + 1
                else
                    manualVerticalInput = true
                    Nav.axisCommandManager:setThrottleCommand(axisCommandId.vertical, 0)
                    Nav.axisCommandManager:deactivateGroundEngineAltitudeStabilization()
                    Nav.axisCommandManager:updateCommandFromActionStart(axisCommandId.vertical, -1.0)
                end
        actionLoop:
            args: [down]
            lua: |
                if altitudeHold ~= nil then
                    altitudeHold = altitudeHold - 10
                end
        actionStop:
            args: [down]
            lua: |
                manualVerticalInput = false
                if unit.getAxisCommandValue(2) == -1 then
                    Nav.axisCommandManager:updateCommandFromActionStop(axisCommandId.vertical, 1.0)
                end
                if groundStabilization then
                    Nav.axisCommandManager:activateGroundEngineAltitudeStabilization()
                end
        actionStart:
            args: [groundaltitudeup]
            lua: Nav.axisCommandManager:updateTargetGroundAltitudeFromActionStart(1.0)
        actionLoop:
            args: [groundaltitudeup]
            lua: Nav.axisCommandManager:updateTargetGroundAltitudeFromActionLoop(1.0)
        actionStart:
            args: [groundaltitudedown]
            lua: Nav.axisCommandManager:updateTargetGroundAltitudeFromActionStart(-1.0)
        actionLoop:
            args: [groundaltitudedown]
            lua: Nav.axisCommandManager:updateTargetGroundAltitudeFromActionLoop(-1.0)
        inputText(text):
            lua: |
                wtRadar.onTextInput(text)
                wtPilotHud.onText(text)
    shield:
        down():
            lua: |
                wtShield.onDown()
        venting(active, restoredHitpoints):
            lua: |
                wtShield.onVentingEvent(active, restoredHitpoints)
        absorbed(hitpoints, hitpointsRaw):
            lua: |
                wtShield.onAbsorb(hitpoints, hitpointsRaw)
                dpsReporter.onDamage(hitpoints)
    weapon_1:
        onHit(targetId,damage):
            lua: |
                dpsReporter.weaponOnHit(targetId, damage)
        onMissed(targetId):
            lua: |
                dpsReporter.weaponOnMiss(targetId)
        onElementDestroyed(targetId,elementId):
            lua: |
    weapon_2:
        onHit(targetId,damage):
            lua: |
                dpsReporter.weaponOnHit(targetId, damage)
        onMissed(targetId):
            lua: |
                dpsReporter.weaponOnMiss(targetId)
        onElementDestroyed(targetId,elementId):
            lua: |
    weapon_3:
        onHit(targetId,damage):
            lua: |
                dpsReporter.weaponOnHit(targetId, damage)
        onMissed(targetId):
            lua: |
                dpsReporter.weaponOnMiss(targetId)
        onElementDestroyed(targetId,elementId):
            lua: |
    weapon_4:
        onHit(targetId,damage):
            lua: |
                dpsReporter.weaponOnHit(targetId, damage)
        onMissed(targetId):
            lua: |
                dpsReporter.weaponOnMiss(targetId)
        onElementDestroyed(targetId,elementId):
            lua: |
    weapon_5:
        onHit(targetId,damage):
            lua: |
                dpsReporter.weaponOnHit(targetId, damage)
        onMissed(targetId):
            lua: |
                dpsReporter.weaponOnMiss(targetId)
        onElementDestroyed(targetId,elementId):
            lua: |
    weapon_6:
        onHit(targetId,damage):
            lua: |
                dpsReporter.weaponOnHit(targetId, damage)
        onMissed(targetId):
            lua: |
                dpsReporter.weaponOnMiss(targetId)
        onElementDestroyed(targetId,elementId):
            lua: |
